{{ define "main" }}
<main class="books-layout">
    <section class="books-catalog">
        <header class="books-catalog__header">
            <h1>Каталог книг по боевым искусствам{{/* .Title */}}</h1>
            {{ with .Content }}
            <div class="books-catalog__intro">
                {{ . }}
            </div>
            {{ end }}
        </header>
        {{ $pages := where .Site.RegularPages "Section" "books" }}
        {{ $pages = sort $pages ".Params.year" "desc" }}

        {{ if not $pages }}
        <p>В этой секции пока нет книг.</p>
        {{ else }}

        {{/* Группируем по году вручную, используя уже отсортированный список */}}
        {{ $currentYear := "" }}

        {{ range $pages }}
        {{ $year := printf "%v" .Params.year }}

        {{ if ne $year $currentYear }}
        {{/* Закрываем прошлую группу (если она была) и открываем новую */}}
        {{ if ne $currentYear "" }}
        </div> <!-- .books-catalog__grid для предыдущего года -->
        {{ end }}

        {{/* считаем сколько книг в этом году */}}
        {{ $yearPages := where $pages "Params.year" .Params.year }}

        <section class="books-year-group">
            <h2 class="books-year-group__title">
                {{ $year }}
                {{/* функция склонения */}}
                {{ $count := len $yearPages }}
                {{ $n := mod $count 100 }}
                {{ $n1 := mod $count 10 }}
                {{ $word := "" }}

                {{ if and (ge $n 11) (le $n 14) }}
                {{ $word = "книг" }}
                {{ else if eq $n1 1 }}
                {{ $word = "книга" }}
                {{ else if and (ge $n1 2) (le $n1 4) }}
                {{ $word = "книги" }}
                {{ else }}
                {{ $word = "книг" }}
                {{ end }}

                <span class="books-year-group__count">
  ({{ $count }} {{ $word }})
</span>


            </h2>

            <div class="books-catalog__grid">
                {{ $currentYear = $year }}
                {{ end }}

                {{/* Карточка книги внутри текущего года */}}
                <article class="books-card">
                    <a href="{{ .RelPermalink }}" class="books-card__link">

                        {{ with .Resources.GetMatch "cover.*" }}
                        <div class="books-card__cover">
                            <img src="{{ .RelPermalink }}" alt="Обложка: {{ $.Title }}">
                        </div>
                        {{ end }}

                        <div class="books-card__body">
                            <h2 class="books-card__title">«{{ .Title }}»
                                {{ with .Params.subTitle }}
                                <span class="books-card__subtitle"> {{ . }}</span>
                                {{ end }}
                            </h2>

                            {{ with .Params.creators }}
                            <div class="books-card__authors">
                                {{ range $i, $c := . }}
                                {{ if $i }}, {{ end }}
                                {{ with $c.given }}{{ . }} {{ end }}{{ $c.family }}
                                {{ end }}
                            </div>
                            {{ end }}

                            <div class="books-card__meta">
                                {{ with .Params.year }}
                                <span class="books-card__year">
                                {{ . }}
                                </span>
                                {{ end }}

                                {{ with .Params.bookgenres }}
                                <span class="books-card__genres">
                                {{ range $i, $g := . }}
                                {{ if $i }}, {{ end }}{{ $g }}
                                {{ end }}
                                </span>
                                {{ end }}

                                {{ with .Params.bookshelves }}
                                <span class="books-card__shelves">
                                {{ range $i, $s := . }}
                                {{ if $i }}, {{ end }}{{ $s }}
                                {{ end }}
                                </span>
                                {{ end }}
                            </div>

                            <div class="books-card__rating">
                            {{/* Рейтинг 0–10, целый */}}
                            {{ with .Params.rating }}
                            {{ $rating := int . }}
                            {{ $max := 10 }}
                            <p class="book__rating">
                                <strong></strong>
                                {{ range seq 1 $max }}
                                {{ if le . $rating }}
                                ★
                                {{ else }}
                                ☆
                                {{ end }}
                                {{ end }}
                                <span class="book__rating-value">({{ $rating }}/10)</span>
                            </p>
                            {{ end }}
                            </div>

                            {{ with .Params.abstractNote }}
                            <p class="books-card__abstract">
                                {{ . }}
                            </p>
                            {{ else }}
                            {{ with .Summary }}
                            <p class="books-card__abstract">
                                {{ . }}
                            </p>
                            {{ end }}
                            {{ end }}
                        </div>
                    </a>
                </article>

                {{ end }}

                {{/* закрываем последнюю открытую .books-catalog__grid и секцию года */}}
            </div> <!-- .books-catalog__grid -->
        </section>

        {{ end }}
    </section>
</main>
{{ end }}
